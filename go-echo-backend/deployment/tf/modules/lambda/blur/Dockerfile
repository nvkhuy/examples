#https://docs.aws.amazon.com/lambda/latest/dg/typescript-image.html

FROM --platform=linux/amd64 public.ecr.aws/lambda/nodejs:18 as builder
WORKDIR /usr/app
COPY package.json *.ts  ./
RUN npm install
RUN npm run build

ARG BUILD_ENV
ARG BUILD_VERSION
ARG BUILD_NUMBER
ARG BUILD_TIMESTAMP

ENV BUILD_ENV=${BUILD_ENV}
ENV BUILD_VERSION=${BUILD_VERSION}
ENV BUILD_TIMESTAMP=${BUILD_TIMESTAMP}
ENV BUILD_NUMBER=${BUILD_NUMBER}

RUN echo "BUILD_ENV=$BUILD_ENV BUILD_NUMBER=$BUILD_NUMBER BUILD_VERSION=$BUILD_VERSION BUILD_TIMESTAMP=$BUILD_TIMESTAMP"

# Setup runner
FROM public.ecr.aws/lambda/nodejs:18

ARG BUILD_ENV
ARG BUILD_VERSION
ARG BUILD_NUMBER
ARG BUILD_TIMESTAMP

ENV BUILD_ENV=${BUILD_ENV}
ENV BUILD_VERSION=${BUILD_VERSION}
ENV BUILD_TIMESTAMP=${BUILD_TIMESTAMP}
ENV BUILD_NUMBER=${BUILD_NUMBER}

RUN echo "BUILD_ENV=$BUILD_ENV BUILD_NUMBER=$BUILD_NUMBER BUILD_VERSION=$BUILD_VERSION BUILD_TIMESTAMP=$BUILD_TIMESTAMP"

WORKDIR ${LAMBDA_TASK_ROOT}
COPY --from=builder /usr/app/dist/* ./
COPY --from=builder /usr/app/node_modules ./

COPY .env ./.env
CMD ["index.handler"]